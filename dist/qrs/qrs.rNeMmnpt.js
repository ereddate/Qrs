import"../chunks/typeCheck.Cq0qUGfz.js";const f=[],m=new Set;let E=!1;const p=new WeakMap;function d(e){m.add(e),E||(E=!0,Promise.resolve().then(C),u(()=>{Function.is(window.globalAfterQueueJob)&&window.globalAfterQueueJob()}))}function C(){try{m.forEach(e=>e())}finally{E=!1,m.clear(),u(()=>{const e=new CustomEvent("globalUpdateCompleted");window.dispatchEvent(e)})}}function U(){const e={};return{on(t,s){e[t]||(e[t]=[]),e[t].push(s)},emit(t,...s){e[t]&&e[t].forEach(n=>n(...s))}}}function w(e,t){if(Object.is(e)||e===null)return e;if(p.has(e))return p.get(e);const s=new Map,n={},a=U();if(Function.is(Proxy)){const r=new Proxy(e,{get(i,o){if(f.length>0){const h=f[f.length-1];s.has(o)||s.set(o,new Set),s.get(o).add(h)}const c=i[o];return Object.is(c)&&c!==null?w(c):c},set(i,o,c){if(Object.is(i[o],c))return!0;const h=i[o];return i[o]=c,s.has(o)&&s.get(o).forEach(l=>d(l)),Function.is(t)&&u(()=>{t(o,h,c)}),!0},deleteProperty(i,o){if(o in i){const c=i[o];return delete i[o],s.has(o)&&s.get(o).forEach(h=>d(h)),Function.is(t)&&u(()=>{t(o,c,void 0)}),a.emit("delete",o,c),!0}return!1}});return p.set(e,r),r}else{for(const r in e)if(e.hasOwnProperty(r)){let i=e[r];const o=new Set;s.set(r,o),Object.defineProperty(n,r,{get(){if(f.length>0){const c=f[f.length-1];o.add(c)}return Object.is(i)&&i!==null?w(i):i},set(c){if(Object.is(i,c))return;const h=i;i=c,o.forEach(l=>d(l)),Function.is(t)&&t(r,h,c)}})}return n.$set=function(r,i){if(!(r in n)){let o=new Set;s.set(r,o),Object.defineProperty(n,r,{get(){if(f.length>0){const c=f[f.length-1];o.add(c)}return Object.is(i)&&i!==null?w(i):i},set(c){if(Object.is(i,c))return;const h=i;i=c,o.forEach(l=>d(l)),Function.is(t)&&u(()=>{t(r,h,c)})}}),a.emit("add",r,i),Function.is(t)&&u(()=>{t(r,void 0,i)})}n[r]=i,u(()=>{var o;Function.is((o=this.props)==null?void 0:o.afterSet)&&this.props.afterSet.call(this,r,i)})},n.$delete=function(r){if(r in n){const i=n[r];delete n[r],s.delete(r),a.emit("delete",r,i),Function.is(t)&&u(()=>{t(r,i,void 0)}),u(()=>{var o;Function.is((o=this.props)==null?void 0:o.afterDelete)&&this.props.afterDelete.call(this,r,i)})}},n.$on=a.on.bind(a),p.set(e,n),n}}function j(e){let t,s=!0;const n=new Set,a=()=>{s||(s=!0,n.forEach(i=>d(i)),u(()=>{var i;Function.is((i=this.props)==null?void 0:i.afterComputedUpdate)&&this.props.afterComputedUpdate.call(this)}))};return{get(){if(s&&(f.push(a),t=e(),f.pop(),s=!1),f.length>0){const i=f[f.length-1];n.add(i)}return t}}}function x(e,t){let s;if(Function.is(e))s=e;else if(String.is(e))s=()=>{let r=this.data;const i=e.split(".");for(const o of i)if(r&&Object.is(r))r=r[o];else return;return r};else throw new Error("watch 的第一个参数必须是函数或字符串");let n=s();const a=()=>{f.push(a);const r=s();f.pop(),Object.is(r,n)||(t(n,r),n=r,u(()=>{var i;Function.is((i=this.props)==null?void 0:i.afterWatchUpdate)&&this.props.afterWatchUpdate.call(this,n,r)}))};f.push(a),s(),f.pop()}class P{constructor(t){var n,a,r,i;const s=this;return(a=(n=this.props)==null?void 0:n.beforeCreated)==null||a.call(this),this.props=t,this.$slots=t.slots||{},this.data=w(Function.is(t.data)?t.data.call(this):t.data||{},function(o,c,h){s.update(o,c,h)}),t.computed&&Object.keys(t.computed).forEach(o=>{const c=j.bind(this)(t.computed[o].bind(this));Object.defineProperty(this.data,o,{get:c.get})}),t.watch&&Object.keys(t.watch).forEach(o=>{const c=t.watch[o].bind(this);x.bind(this)(this.data[o],c)}),this.el=null,(i=(r=this.props)==null?void 0:r.created)==null||i.call(this),u(()=>{var o;Function.is((o=this.props)==null?void 0:o.afterComponentInit)&&this.props.afterComponentInit.call(this)}),this}render(){var s,n,a,r,i;(n=(s=this.props)==null?void 0:s.beforeMount)==null||n.call(this);const t=(a=this.props)==null?void 0:a.render.bind(this)(this.$slots);return(i=(r=this.props)==null?void 0:r.mounted)==null||i.call(this),u(()=>{var o;Function.is((o=this.props)==null?void 0:o.afterMount)&&this.props.afterMount.call(this)}),t}update(){var s,n,a,r,i,o;(n=(s=this.props)==null?void 0:s.beforeUpdate)==null||n.call(this);const t=this.render();this.el&&this.el.isEqualNode(t)||((a=this.el)!=null&&a.parentNode?this.el.parentNode.replaceChild(t,this.el):(r=this.el)==null||r.replaceWith(t),this.el=t,(o=(i=this.props)==null?void 0:i.updated)==null||o.call(this),u(()=>{var c;Function.is((c=this.props)==null?void 0:c.afterUpdate)&&this.props.afterUpdate.call(this)}))}unmount(){var t,s,n,a,r;(s=(t=this.props)==null?void 0:t.beforeUnmount)==null||s.call(this),(n=this.el)==null||n.remove(),this.el=null,this.props=null,(r=(a=this.props)==null?void 0:a.unmounted)==null||r.call(this),u(()=>{var i;Function.is((i=this.props)==null?void 0:i.afterUnmount)&&this.props.afterUnmount.call(this)})}$emit(t,...s){var a,r;const n=(r=(a=this.props)==null?void 0:a.on)==null?void 0:r[t];n&&(Array.isArray(n)?n.forEach(i=>i.apply(this,s)):n.apply(this,s))}}const g=function(e){return e instanceof P},F=function(e){return e instanceof b},S=function(e,t){const s={};Object.keys(t).forEach(n=>{const a=n==="style"?e.style.cssText:e[n],r=t[n];if(a!==r)switch(n){case"style":Object.assign(s,t[n]);break;case"class":e.className=t[n];break;case"html":e.innerHTML=t[n];break;case"text":e.textContent="",e.appendChild(document.createTextNode(t[n]));break;case"on":Object.keys(t[n]).forEach(i=>{e.addEventListener(i,function(){t[n][i].call(t,...arguments)})});break;default:e.setAttribute(n,t[n]);break}}),Object.keys(s).length>0&&Object.assign(e.style,s),u(()=>{var n;Function.is((n=e.props)==null?void 0:n.afterPropsUpdate)&&e.props.afterPropsUpdate.call(e)})},O=function(e,t){t.forEach(s=>{if(g(s)||F(s)){const n=new s.constructor(s.props),a=n.render();n.el=a,e.appendChild(a)}else String.is(s)?e.appendChild(document.createTextNode(s)):Array.isArray(s)?O.bind(this)(e,s):e.appendChild(s)}),u(()=>{var s;Function.is((s=e.props)==null?void 0:s.afterChildrenUpdate)&&e.props.afterChildrenUpdate.call(e)})};class b{constructor(t,s,n){return this.tag=t,this.props=s,this.children=n,this.el=null,this}is(t){return t instanceof b}render(){if(g(this.tag)||F(this.tag)){const n=new this.tag.constructor(this.props).render();return this.el=n,n}const t=this.tag==="text"?document.createTextNode(""):document.createElement(this.tag);return this.props&&S.bind(this)(t,this.props),this.children&&O.bind(this)(t,this.children),t}}const N=(e,t,...s)=>{if(g(e)){const r=[];r.default=s;const i=new e.constructor({...e.props,...t,slots:r}),o=i.render();return i.el=o,o}return new b(e,t,s).render()};function A(e){return document.querySelector(e)}function V(e){return{mount(t){t=A(t);const s=e.render();e.el=s,t.appendChild(s),u(()=>{var n;Function.is((n=e.props)==null?void 0:n.afterAppMount)&&e.props.afterAppMount.call(e)})}}}function u(e){if(Function.is(e))Promise.resolve().then(e);else return Promise.resolve()}export{P as C,V as a,N as c,w as r};
